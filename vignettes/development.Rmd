---
title: "Guide to using MR.TRAM"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{development}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = TRUE
)
```

The following analyses should run within a couple of minutes, depending on internet speed and the traffic that the [IEU GWAS database](https://gwas.mrcieu.ac.uk/) servers are experiencing. Begin by choosing an exposure and outcome hypothesis that can be tested across the populations of interest (e.g. body mass index and coronary heart disease in European ancestry and East Asian ancestry). 


## Data setup

To install MR-TRAM:

```r
install.packages("devtools")
devtools::install_github("universe77/MR.TRAM")
```

Open R6 class environment to run MR-TRAM. Plink (ver.1.90) and LD reference data are also required to identify instruments that can be used for both populations: http://fileserve.mrcieu.ac.uk/ld/1kg.v3.tgz 

```{r setup}
library(MR.TRAM)

# Need to specify path to plink and LD reference data here.
# The following exposures and the outcomes will be used: Exposures: CRP (EUR-EAS); Outcomes: CHD (EUR-EAS)
x <- MultiAncestrySummarySet$new(
	exposure_ids=c("ieu-b-35", "ukb-e-30710_EAS"), 
	outcome_ids=c("ieu-a-7", "bbj-a-109"), 
	bfiles=c("/work/yc16575/1kg_imp_gwasglue/EAS", "/work/yc16575/1kg_imp_gwasglue/EAS"), 
	plink = genetics.binaRies::get_plink_binary(), 
	radius=50000, 
	clump_pop="ASN"
)
```

Make sure that the exposures/outcomes are matched across the ancestries. Population 1 and 2 should have the same exposure-outcome pair. These data can be extracted from the IEU GWAS database using the [TwoSampleMR](https://mrcieu.github.io/TwoSampleMR/) package. A list of available traits can be obtained using:
```{r}
traits <- TwoSampleMR::available_outcomes()
```

## Running MR.TRAM

We can now perform the analysis, which will do the following:

1. Extract instruments for the exposures
2. Check the validity of the instruments
3. Identify region that include the instrument and extract instruments again from identified region
4. Extract instruments for the outcomes
5. Perform MR using genomic structural equation model


## Step by step analysis 

See the `?MR.TRAM` for options on the parameters for this analysis. 

### Step 1. Extract instruments for the exposures from each pouplation
Note that the exposures/outcomes should be matched across the ancestries. 

```{r}
x$extract_instruments()
```

### Step 2. Check the validity of the instruments
The degree of agreement in instrument associations (instrument-traits) between populations need to be assessed.

```{r}
x$check_instruments()
```
Low degree of agreement (< 0.5) indidcates that the instruments are not reliable for further analysis. It is recommened to use other available instruments for the traits (https://gwas.mrcieu.ac.uk/). If the units for the exposures and the outcomes are different, use `strandardise=TRUE` options when it extract instrument for the outcomes. 

Then estimate what fraction of the instruments (raw instrument) we would expect to replicate across the populations.

```{r}
x$estimate_instrument_specificity(x$instrument_raw)
```

### Step 3. Identify region that include the instrument and extract instruments again from the identified region
The following function will identify region that includes the instrument. Then it will extract instruments again from the identified region. Instruments will be selected based on magnitude of instrument-exposure association.

```{r, fig.width = 7, fig.height = 6, out.width = "700px", out.height="600px", dpi=300}
# Identify regions that include the instruments
x$extract_instrument_regions()

# Extract instrument from identified region by searching across region for best associations
x$scan_regional_instruments()

# Plot regions and their region-selected instruments
x$plot_regional_instruments(instruments=x$instrument_maxz)
```

Check the replication fraction between the populations using the new instruments (instrument_maxz).
```{r}
# Estimate what fraction of the region-selected instruments we'd expect to replicate
x$estimate_instrument_specificity(x$instrument_maxz)
```

### Step 4. Extract instruments for the outcomes
Get outcome data for a particular set of instruments 
```{r}
x$extract_outcome_data(exp=x$instrument_raw, p_exp=1)
```
When the units are not the same between the populations, the beta and SE for the exposure and the 
outcome should be normalised using:

```{r}
x$extract_outcome_data(exp=x$instrument_raw, standardise=TRUE, p_exp=1)
```

### Step 5. Perform MR using genomic structural equation model (MR-SEM)
```{r}
x$perform_basic_sem()
```


You can also perfrom MR-SEM using the instruments from the Step 3.
```{r}
# Get outcome data for a particular set of instruments and run SEM model 
x$extract_outcome_data(exp=x$instrument_maxz, p_exp=1)
x$perform_basic_sem()

```


