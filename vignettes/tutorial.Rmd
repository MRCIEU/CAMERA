---
title: "Tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CAMERA)
```


## Introduction

This software attempts to bring together various tools to improve cross-ancestry Mendelian randomisation. It will use an example of performing analysis of BMI on coronary heart disease across four major ancestral groups.

Overview:

- Initialise data
- Check phenotype scales across ancestries
- Extract instruments
- Evaluate instrument heterogeneity across populations
- Extract outcome data
- Harmonise exposure and outcome data
- Perform analysis using raw instruments
- Perform regional scan to obtain LD agnostic instruments
- Re-perform analysis using regional instruments
- Evaluate similarity of pleiotropy across ancestry
- Evaluate similarity of instrument-exposure associations
- Use cross-population instrument-exposure heterogeneity in MR GxE framework to estimate pleiotropy distributions
- Saving and loading data

## Initialise data

```{r}
bfile_dir <- "/Users/gh13047/repo/opengwas-api-internal/opengwas-api/app/ld_files"
x <- CAMERA$new(
  exposure_ids=c("ukb-e-23104_CSA", "ukb-e-21001_AFR", "ukb-b-19953", "bbj-a-1"), 
  outcome_ids=c("ukb-e-411_CSA", "ukb-e-411_AFR", "ieu-a-7", "bbj-a-109"), 
  pops = c("SAS", "AFR", "EUR", "EAS"),
  bfiles=file.path(bfile_dir, c("SAS", "AFR", "EUR", "EAS")),
  plink = genetics.binaRies::get_plink_binary(), 		
  radius=50000, 
  clump_pop="EUR"
)
x
```

## Check phenotype scales across ancestries

```{r}
x$check_phenotypes(ids=x$exposure_ids)
x$check_phenotypes(ids=x$outcome_ids)
```

## Extract instruments

```{r}
x$extract_instruments()
str(x$instrument_raw)
```

## Evaluate instrument heterogeneity across populations

```{r}
x$instrument_heterogeneity()
```

```{r}
x$estimate_instrument_specificity(instrument=x$instrument_raw)
```

## Extract outcome data

```{r}
x$make_outcome_data()
```

## Harmonise exposure and outcome data

```{r}
x$harmonise()
```

## Perform analysis using raw instruments

```{r}
x$cross_estimate()
```

```{r}
x$plot_cross_estimate()
```

## Perform regional scan to obtain LD agnostic instruments

We can re-select the instruments scanning across the region. The intention here is to allow all populations to contribute to a fixed effects meta analysis to account for LD. Then the top variant in the region from the meta analysis is used as the instrument for all populations.

```{r, message=FALSE}
x$extract_instrument_regions()
```

This has extracted regions around all the pooled instruments from each exposure dataset. Now we can use either fixed effects meta analysis within each region to choose the best SNP across all ancestries:

```{r}
x$fema_regional_instruments() %>% str()
```

or use a Z-score based meta analysis if you are unsure about whether the effect size scales are sufficiently consistent across the studies:

```{r}
x$get_metadata()
x$fema_regional_instruments(method="zma") %>% str()
```

## Re-perform analysis using regional instruments

Note that we're now making a copy of `x` to change the `x$outcome_outcome` and `x$harmonised_dat` objects to reflect the regional instrument selection. But because `x` is an R6 class object, we need to explicitly use the `x$clone()` function to create a new copy.

```{r}
x1 <- x$clone()
x$make_outcome_data(exp=x1$instrument_fema)
x$harmonise(exp=x1$instrument_fema)
x$cross_estimate()
```

```{r}
x$plot_cross_estimate()
```

Evaluate instrument specificity. First using heterogeneity

```{r}
x$instrument_heterogeneity(x$instrument_fema)
```

Compared to above the `agreement` regression slopes are much closer to 1 for all ancestries.

```{r}
x$estimate_instrument_specificity(x$instrument_fema, alpha = "bonferroni")
x$instrument_specificity$distinct %>% table
```

The number of apparently distinct instruments is reduced also.

<!-- ## Attempt to re-scale instrument-exposure associations -->

```{r, eval=FALSE, echo=FALSE}
x1$standardise_data()
x$instrument_heterogeneity(x$instrument_raw)
x1$instrument_heterogeneity(x1$instrument_raw)
```

```{r, eval=FALSE, echo=FALSE}
x$make_outcome_data(exp=x$instrument_fema)
x$harmonise(exp = x$instrument_fema)
x$cross_estimate()
x$plot_cross_estimate()
```

## Evaluate similarity of pleiotropy across ancestry

Note: the term pleiotropy used here refers to 'horizontal pleiotropy', the influence of the SNP on the outcome not mediated through the exposure. 

Here we will find pleiotropy outliers from the MR analysis, and then determine if the deviation of those outliers from the overall MR estimates is consistent across populations

```{r}
x$pleiotropy()
```

Outliers are detected based on whether a SNP's Wald ratio (in a particular population) is substantially different from the overall estimate. The overall estimate is the combined meta-analysis across all populations and all SNPs, unless that population's overall MR estimate contributed substantially to heterogeneity. In that case, deviation is estimated based on the population's specific MR estimate.

```{r}
x$pleiotropy_outliers
```


For outliers from a population, are other populations showing similar deviation to the outlier discovery population? e.g. look at whether the sign is the same for outliers discovered in Europeans:

```{r}
x$pleiotropy_agreement %>% as.data.frame %>% subset(disc == "EUR" & metric=="Sign")
```


Look at the overall relationship of outlier deviations across populations

```{r}
x$plot_pleiotropy()
```

Identify any variants that showed substantial differences in pleiotropy deviations across populations. Note that sometimes the pleiotropy deviation estimate is unstable due to the SNP-exposure association being very small. Unstable estimates are attempted to be removed automatically from the heterogeneity analysis

```{r}
x$plot_pleiotropy_heterogeneity(pthresh=0.05)
```

No SNPs are showing substantial differences in pleiotropy deviation across populations. Plot everything by relaxing the threshold

```{r}
x$plot_pleiotropy_heterogeneity(pthresh=1)
```


## MR GxE

The MR GxE model aims to estimate the horizontal pleiotropic effect of a SNP. This is achieved by estimating its effect on the outcome in a subset of the data where the SNP is not expected to have an association (the zero relevance group). The cross-ancestry MR analysis can attempt to make use of this approach by identifying variants that exhibit heterogeneity in the instrument-exposure association across ancestries. Those instruments can then be used to estimate the pleiotropic association by evaluating their effect on the outcome across populations showing differential SNP-exposure associations.

First identify examples of heterogeneity amongst instrument-exposure associations

```{r}
x$estimate_instrument_heterogeneity_per_variant()
x$instrument_heterogeneity_per_variant %>% dplyr::filter(Qfdr < 0.05)
```

Next perform MR GxE (may take a couple of minutes while bootstraping standard errors)

```{r}
x$mrgxe()
x$mrgxe_res
```

This is the distribution of the estimate of the pleiotropic effect of each SNP that showed heterogeneity

```{r}
x$mrgxe_plot()
```

Any evidence of SNPs with substantial heterogeneity?

```{r}
x$mrgxe_res %>% dplyr::filter(p.adjust(a_pval, "fdr") < 0.05)
```

It's worth always checking if these look credible e.g. this plots the SNP-exposure against SNP-outcome associations for the identified SNPs. You'd expect to see a slope reflecting the causal effect estimate with the intercept reflecting the pleiotropic association. 

```{r}
x$mrgxe_plot_variant()
```

In this case the associations are very noisy, and it would be difficult to justify that they show convincing evidence of the pleiotropy estimate.


## Saving and loading data

It can be useful to import data from one CAMERA object to another, because for example you may have all your data, but the CAMERA class has been updated, and you want to initialise a new class and import all the old data into the new class.

Save CAMERA objects as RDS files e.g.

```{r, eval=FALSE}
saveRDS(x, file="example-CAMERA.rds")
```

And load them like this:

```{r, eval=FALSE}
x <- readRDS(file="example-CAMERA.rds")
```

You can import data from one CAMERA object to another like this:

```{r, eval=FALSE, echo=FALSE}
load_all()
x1 <- readRDS(file="example-CAMERA.rds")
x <- CAMERA$new()
x$import(x1)
x$pleiotropy()
x$plot_pleiotropy()
x$plot_pleiotropy_heterogeneity(pthresh=0.05)
```

